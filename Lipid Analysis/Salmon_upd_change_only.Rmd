---
title: "Food Analysis"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '6'
    toc_float: true
    number_sections: true
    code_folding: hide
---
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 10px;}
</style>
<div class = "blue">
**Background**
Need to run the "setting_all_names.Rmd" code file first before using this code file, and create the following folders:"Analysis_plots", "food_table", "Missing_plot", "Normalization_plot".

* Summary:
  + There are 107 unique to salmon metabolites, in which 64 Metabolites are named and 43 are unnamed Metabolites.
  + There were 3 metabolites that had more than 75% total missing, and thus they were excluded from further analysis. 
  + There are 11 Health Outcomes that we are interested in: SBP, DBP, Insulin, Chol_T, TG, LDL, HDL, CRP, ApoB, HDL/LDL, Chol_T/HDL.
  + There are 41 individual who participated in this study, in which there were 28 females and 11 males.

* There are 3 goals that we are trying answer:
  + Goal 1: Do we detect more or higher quantity of unique to salmon metabolites after consuming Mediterranean diet.
  + Goal 2: Is there a relationship between change in unique to salmon metabolites and health outcomes cross-sectionally.
  + Goal 3: Is there a relationship between change in unique to salmon metabolites and change in health outcomes after consuming Mediterranean diet.

* Analysis done:
  + Association between Health outcomes and Metabolites Using Linear Mixed Model(LMM).***Goal 2***
  + Stratified analysis based on Time (pre and post) for Health Outcomes and Metabolites by using LMM.***Goal 2***
  + Stratified analysis based on Period (pre 1, post 1, pre 2, post 2) for Health Outcomes and Metabolites by using Linear Model (LM).***Goal 2***
  + Checking for influential points in HDL and c.1, which meets the FDR threshold for pre but fails p-value in post using Cook's Distance.
  + Association between Health Outcomes and sum of Metabolites by using LMM.
  + Association between change(post - pre) in Health Outcomes and change(post - pre) in Metabolites by using LMM. ***Goal 3***
  + Association between the change in ranks of Metabolite by using LMM. ***Goal 1***
      + First formula is without covariates, which is the primary analysis.
      + Second formula is with covariates, in which covariates of "Age" and "Sex" are scaled.
  + Stratified analysis based on Sex(Male and Female) for change in metabolite using both formulas mentioned above.***Goal 1***
  + Association between change in Health Outcomes and sum of change in Metabolite by using LMM.***Goal 3***
  + Association between the sum of change in ranks of Metabolite by using LMM.***Goal 3***
      + First formula is without covariates, which is the primary analysis.
      + Second formula is with covariates, in which covariates of "Age" and "Sex" are scaled.


</div>

# Data Prep
### Libraries
Requires the following packages: "dplyr", "ggplot2", "lmerTest", "stringr", "DT", "data.table", "faraway", and "plotly"
```{r message=FALSE}
## Install the following packages 
##install.packages("ggplot2")
##install.packages("lmerTest")
##install.packages("stringr")
##install.packages("DT")
##install.packages("faraway")
library(dplyr)
library(ggplot2)
library(lmerTest)
library(stringr)
library(DT)
library(data.table)
library(faraway)
library(plotly)
library(cowplot)
library(htmlwidgets)
```
      
Insert Targeted Health Outcomes and constant to multiply the IQR 
```{r}
food_name <- "salmon"
outcomes <- c("SBP_total","DBP_total","Insulin","Chol_T","TG","LDL","HDL","CRP","ApoB","HDL_LDL","Chol_T_HDL")
constant_IQR <- 1.5
print(outcomes)
```

### Reading in Data
``` {r}
## Read in Targeted File as "food", and health files
food <- as.data.frame(read.table("./merged_file.txt",check.names=F))

diff_in_health_outcome <- read.table(file="./health_outcome.txt",header=T)
complete_health_outcome <- read.table(file="./complete_health_outcome.txt",header=T)

datatable(as.data.frame(food),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50,100)),
          class="cell-border stripe", caption=paste0("Original ",food_name," Dataset"))

write.csv(food, paste0("./food_table/",food_name," Original_Dataset.csv"), row.names=F)
```

Assigning Metabolite Names Such as: "c.1", "c.2", ... to Unique to Salmon Metabolites
```{r}
metabolite_info <- as.data.frame(read.table("./met_info.txt",header=T))

Metabolite <- paste("c.",1:nrow(metabolite_info),"_lp", sep = "")
metabolite_info <- cbind(Metabolite,metabolite_info)

datatable(as.data.frame(metabolite_info),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50)),
          class="cell-border stripe", caption="Summary Information for Metabolites")

write.csv(metabolite_info, paste0("./food_table/",food_name,"  Metabolite_Information.csv"), row.names=F)

## Naming Columns for "food" 
colnames(food)[10:ncol(food)] <- Metabolite
food <-  food[complete.cases(food[,Metabolite]),]
```

Identify Missing Values and Replace Them with value of 1
```{r}
## We know that missing values have a value of 0.00001
food[food==0.00001] <- 1
```

# Calculating Absence(missing) Values of Metabolites 
Total Sum and Percent Missing for Each of "Total", "Post" and "Pre" Interventions are Calculated. If a Value in "food" is 1, That is Missing
```{r}
## Calculating Missing in "Post" and "Pre"
intervention_time <- c("Post","Pre")
missing_interv <- percent_missing_interv <- data.frame(matrix(ncol=length(Metabolite),nrow=length(intervention_time)))
      
for(i in 1:length(intervention_time)){
  missing_interv[i,] <- as.vector(colSums(food[grepl(intervention_time[i], food$StudyID),Metabolite]==1, na.rm = T))
  rownames(missing_interv)[i] <- paste0("missing_",intervention_time[i])
  percent_missing_interv[i,] <- (missing_interv[i,]/(sum(grepl(intervention_time[i], food$StudyID))))*100
  rownames(percent_missing_interv)[i] <- paste0("percent_missing_",intervention_time[i])
}

results_test <- rbind(missing_interv, percent_missing_interv)
colnames(results_test) <- Metabolite

## Calculating Total Missing 
total_missing_interv <- as.vector(colSums(food[!grepl("QC", food$StudyID),Metabolite]==1,na.rm=T))
percent_total_missing_interv <- (total_missing_interv/(sum(!grepl("QC", food$StudyID))))*100
results_total <- as.data.frame(rbind(total_missing_interv, percent_total_missing_interv))
colnames(results_total) <- Metabolite

## Binding Calculated Missing to Main Data
missing_summary <- as.data.frame(t(rbind(results_test, results_total))) 
missing_summary <- missing_summary[,c("missing_Pre","percent_missing_Pre","missing_Post","percent_missing_Post",
                                    "total_missing_interv","percent_total_missing_interv")]

## Showing four significant digits
missing_summary <- round(missing_summary,digits = 4)

missing_summary$Metabolite <- rownames(missing_summary)
missing_summary <- merge(missing_summary,metabolite_info,by="Metabolite")

correct_ord <- missing_summary$Metabolite[order(nchar(missing_summary$Metabolite),missing_summary$Metabolite)]
missing_summary <- missing_summary[match(correct_ord,missing_summary$Metabolite),]
```
      
### Removing Metabolites With More Than 75% Total Missing 
Removed Metabolites 12, 49, and 69 Which had a Total Missing more than 75%
```{r}
Metabolite <- missing_summary$Metabolite[missing_summary$percent_total_missing_interv < 75]
missing_summary <- missing_summary[missing_summary$percent_total_missing_interv < 75,]

datatable(as.data.frame(missing_summary),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50)),
          class="cell-border stripe", caption="Summary of Missing Calculations After Removing Metabolite wiht More Than 75% Missing")

write.csv(missing_summary, paste0("./food_table/",food_name,"  Summary_Missing_less_75_Percent.csv"), row.names=F)
```

### GGPLOTs for Metabolites with More than 25% Presence 
These Plots Help to Answer our First Goal, Which is If We Detect Unique to Salmon Metabolites in More People After Consuming Mediterranean Diet

#### Plot Comparing Percent of Metabolite Detected in Pre vs Post
This Plot Looks at % Metabolite Detection in "Pre", vs "Post". Which Shows Most Metabolites are Below the x=y Line, Indicating That After Consumption of Salmon There Were More Metabolites Present Compared to "Pre" Intervention. 
```{r}
ggplot(missing_summary, aes((100-percent_missing_Post), (100-percent_missing_Pre)))+
  geom_point(color="#D55E00") + geom_abline(alpha=0.4, color="#000000")+ geom_count()+ 
  labs(title= "% Detected of metabolite in Pre and Post", y="Pre % Detected", x = "Post % Detected")+
  theme_bw()
```
      
#### Plot Comparing Number of Presence Based on Pre vs Post
This Plot Compares Presence for Each Metabolite Based on Pre vs Post. This Plot Shows That Unique to Salmon Metabolites had a Higher Presence in "Post", Indicating Salmon Metabolites were Often Seen After Consumption of Salmon
```{r}
initial_plot <- ggplot(missing_summary, aes((100-percent_missing_Post), (100-percent_missing_Pre)))+
  geom_point(color="#D55E00") + geom_abline(alpha=0.4, color="#000000")+ geom_count()+ 
  labs(title= "% Detected of metabolite in Pre and Post", y="Pre % Detected", x = "Post % Detected")+
  theme_bw()
 secondary_plot <- ggplot() +geom_linerange(aes(x=sum(!grepl("QC", food$StudyID))-missing_summary$total_missing_interv,
                                    ymin=sum(grepl("Post", food$StudyID))-missing_summary$missing_Post,
                                    ymax=sum(grepl("Pre", food$StudyID))-missing_summary$missing_Pre),
                                colour=ifelse(sum(grepl("Post", food$StudyID))-missing_summary$missing_Post >
                                                sum(grepl("Pre", food$StudyID))-missing_summary$missing_Pre,"#D55E00", "#000000"))+
  geom_point(aes(x=sum(!grepl("QC", food$StudyID))-missing_summary$total_missing_interv,
                 y=sum(grepl("Post", food$StudyID))-missing_summary$missing_Post, colour="#D55E00"))+
  geom_point(aes(x=sum(!grepl("QC", food$StudyID))-missing_summary$total_missing_interv,
                 y=sum(grepl("Pre", food$StudyID))-missing_summary$missing_Pre, colour="#000000"))+
  scale_color_manual("Intervention Differences",labels = c("Pre","Post"),values = c("#000000", "#D55E00"))+
  labs(title="Comparing Detection Based on Intervention", y= "# of Post and Pre Detected", x = "# of Total Detected")+
  theme_bw()+
  theme(
    legend.position="bottom",
    legend.title = element_text(color = "black", size = 10),
    legend.text = element_text(color = "black", size = 10))
  print(secondary_plot)
  plot_row_1<-plot_grid(initial_plot, secondary_plot)
  p.out_1<-plot_grid(plot_row_1, axis="b", label_size=12, vjust=1.5, scale = 0.95)
ggsave2(filename=paste0("Summary_Missing_Plots.jpeg"), plot=p.out_1, device="jpeg",
        path=paste0("./Missing_plot/"))

```

# Implementing log2 on "food"
```{r}
## Implementing log2 and rounding to 4 significant figures
log2_food <- cbind(food[,1:9],round(log2(food[,Metabolite]),4))

## Adding a New Column to Identify QC Values from Human
log2_food$Type <- ifelse(str_detect(log2_food$StudyID, "QC"), "QC", "Human")
```

## Outliers and Normalization
Identifying outlier points and then normalize our values
```{r}
## Identifying and Removing Outliers
## replacing all 0 values in Metabolite with NAs 
log2_food[,Metabolite][log2_food[,Metabolite]==0] <- NA

## Identifying outliers
met_outlier <- as.data.frame(matrix(nrow = nrow(log2_food), ncol = ncol(log2_food[,Metabolite])))
for(i in 1:length(Metabolite)){
  met_loop <- log2_food[,c(Metabolite[i], "order","batch")]
  names(met_loop) <- c("Metabolite", "order", "batch")
  linear_reg <- lm(Metabolite~order*batch, data=met_loop) 
  met_residuals <- as.vector(linear_reg$residuals)
  met_q3 <- quantile(met_residuals, 0.75)
  met_q1 <- quantile(met_residuals, 0.25)
  iqr <- met_q3 - met_q1
  met_outlier[names(residuals(linear_reg)),i] <- met_residuals 
  met_outlier[,i] <- ifelse(met_outlier[,i] > (met_q3 + constant_IQR*iqr) | met_outlier[,i] < (met_q1 - constant_IQR*iqr),F,T)
}

## Replacing T and F with 0 and 1, and Removing Empty Rows
met_outlier <- as.data.frame(sapply(met_outlier, as.numeric))
met_outlier <- met_outlier[rowSums(is.na(met_outlier))!=ncol(met_outlier),]
      
## Removing Outliers 
updated_met <- log2_food
updated_met[,Metabolite] <- mapply('*', updated_met[,Metabolite], met_outlier)
updated_met[,Metabolite][updated_met[,Metabolite] == 0] <- NA #setting outliers to NA
```

### Normalization
Normalizing the Dataset After Removing Outliers
```{r}
## Calculating the normalized values
met_normalized <- as.data.frame(matrix(nrow = nrow(updated_met), ncol = ncol(updated_met[,Metabolite])))
for(i in 1:length(Metabolite)){
  linear_reg_normalized <- lm(updated_met[,Metabolite[i]]~order*batch, data=updated_met)
  predicted_reg <- predict.lm(linear_reg_normalized, newdata = log2_food)
  met_normalized[,i] <- as.data.frame(log2_food[,Metabolite[i]]-predicted_reg)
}

colnames(met_normalized) <- Metabolite
met_normalized <- cbind(select(updated_met,-all_of(Metabolite)),met_normalized)
met_normalized[,Metabolite] <- round(met_normalized[,Metabolite],4)
```

shifting
```{r}
min_shift <- apply(log2_food[Metabolite],2,min,na.rm=T)
met_normalized_shift <- met_normalized
for(i in 1:length(Metabolite)){
  met_normalized_shift[Metabolite[i]] <- met_normalized_shift[Metabolite[i]]+min_shift[i]
}
```
 
CV filter: Calculate SD and Mean of QC values and then do SD/Mean
```{r}
QC_val <- met_normalized_shift[met_normalized_shift$Type=="QC",]

QC_mean <- sapply(QC_val[Metabolite],mean,na.rm=T)
QC_SD <- sapply(QC_val[Metabolite],sd,na.rm=T)
QC_CV <- QC_SD/QC_mean

CV_summary <- as.data.frame(cbind(QC_CV,QC_mean,QC_SD))

Metabolite <- rownames(CV_summary[CV_summary$QC_CV < 0.3,])

met_normalized <- cbind(met_normalized[,1:10],met_normalized_shift[,Metabolite])
```
      
## GGPLOTs of Log2(Raw) Values and Normalized Values vs Order 
### Log2(Raw) vs Order
```{r}
for(i in 1:length(Metabolite)){
  raw_plot <- ggplot(log2_food, aes(x = order, y =log2_food[,Metabolite[i]], color= Type)) + geom_point() + theme_bw() +
    labs(x = "Order", y = "Log2 Values",
         title = paste0(Metabolite[i],":",metabolite_info$Compound[which(metabolite_info$Metabolite==Metabolite[i])]," Log2 Raw Values",
                        sep=""))+
    scale_color_manual(breaks = c("QC", "Human"), values=c("red", "black"))+
    geom_vline(xintercept = 45.5, lty = 2) + geom_vline(xintercept = 112.5, lty = 2)
  print(raw_plot)
}
```
      
### Normalized vs Order
```{r}
for(i in 1:length(Metabolite)){
  normalized_plot <- ggplot(met_normalized, aes(x = order, y =met_normalized[,Metabolite[i]], color=Type)) + geom_point()+
    theme_bw() +
    labs(x = "Order", y = "Normalized Values",
         title =  paste0(Metabolite[i],":",metabolite_info$Compound[which(metabolite_info$Metabolite==Metabolite[i])]," Log2 Normalized Values",
                        sep=""))+
    scale_color_manual(breaks = c("QC", "Human"), values=c("red", "black"))+
    geom_vline(xintercept = 45.5, lty = 2) + geom_vline(xintercept = 112.5, lty = 2)
  print(normalized_plot)
}
```
      
## Spaghetti Plot of Metabolites and Period 
These Plots Show the Normalized Values for For Each Individual Throughout All Periods. In Which Most Metabolites Show an Increase in Their Normalized Values When Changing From "Pre" to "Post", and Also a Decrease From First Trial to Second Trial("Post" to "Pre") Which is the Time Frame that They are Not Consuming Salmon. 
```{r message=FALSE}
normalized_spaghetti <- met_normalized[!(met_normalized$Type=="QC"),]
normalized_spaghetti$StudyID <- gsub(" .*","",normalized_spaghetti$StudyID)

for(i in 1:length(Metabolite)){
  raw_plot <- ggplot(log2_food, aes(x = order, y =log2_food[,Metabolite[i]], color= Type)) + geom_point() + theme_bw() +
    labs(x = "Order", y = "Log2 Values",
         title = paste0(Metabolite[i],":",metabolite_info$Compound[which(metabolite_info$Metabolite==Metabolite[i])],
                        " Log2 Raw Values",sep=""))+
    scale_color_manual(breaks = c("QC", "Human"), values=c("red", "black"))+
    geom_vline(xintercept = 45.5, lty = 2) + geom_vline(xintercept = 112.5, lty = 2)
    normalized_plot <- ggplot(met_normalized, aes(x = order, y =met_normalized[,Metabolite[i]], color=Type)) + geom_point()+
    theme_bw() +
    labs(x = "Order", y = "Normalized Values",
         title =  paste0(Metabolite[i],":",metabolite_info$Compound[which(metabolite_info$Metabolite==Metabolite[i])],
                         " Log2 Normalized Values",
                        sep=""))+
    scale_color_manual(breaks = c("QC", "Human"), values=c("red", "black"))+
    geom_vline(xintercept = 45.5, lty = 2) + geom_vline(xintercept = 112.5, lty = 2)
  spaghetti <- ggplot(normalized_spaghetti,aes(Period,normalized_spaghetti[,Metabolite[i]],
                                                         group=StudyID, colour = Diet))+
    geom_point(color="#56B4E9",size=4) + geom_line(color="#56B4E9")+
    stat_summary(fun=mean, aes(group=1), geom="line", colour="#000000", size = 1) +
    stat_summary(fun=mean, aes(group=1), geom="point", colour="#000000", size=3, shape=4)+
    labs(title=paste0("Spaghetti plot of ",
                      Metabolite[i],":",metabolite_info$Compound[which(metabolite_info$Metabolite==Metabolite[i])]),
         y= "Normalized Value")+ theme_bw() +
    theme(
      axis.text.x = element_text(size = 10, angle = 45, hjust=1),
      plot.title = element_text(size=10,hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      legend.position = "none",
      axis.title.x = element_blank())+
    scale_x_discrete(limits=c("1" = "Pre Trial 1", "2" = "Post Trial 1","3" = "Pre Trial 2", "4"="Post Trial 2"))
  print(spaghetti)
  plot_row<-plot_grid(raw_plot, normalized_plot,spaghetti)
  p.out<-plot_grid(plot_row, axis="b", label_size=12, vjust=1.5, scale = 0.95)
  ggsave2(filename=paste0("Metabolite_", Metabolite[i],".jpeg", sep=""), plot=p.out, device="jpeg",
          path=paste0("./Normalization_plot"))
}
```

# Analysis
Creating Datasets for Analysis Section. 
```{r}
## Removing QC Rows
cross_section_normalized <- as.data.frame(met_normalized[!(met_normalized$Type=="QC"),])

## Replacing "NA" with -999 for Ranking
cross_section_normalized[,Metabolite][is.na(cross_section_normalized[,Metabolite])] <- -999
```

```{r}
cross_section_ranked <- cross_section_normalized
cross_section_ranked[,Metabolite] <- as.data.frame(apply(cross_section_ranked[,Metabolite],2,function(x)
  rank(x,ties.method="average",na.last="keep")))

## Modifying the "StudyID" to Only Include IDs
cross_section_ranked$StudyID <- gsub(" .*","",cross_section_ranked$StudyID)

## Changing Columns  "StudyID", "Period", "Trial", and "Sex" to Factors and "Age" to Numeric
cross_section_ranked[,c("StudyID","Period","Trial","Sex")] <-
  lapply(cross_section_ranked[,c("StudyID","Period","Trial","Sex")],factor)
cross_section_ranked$Age <- as.numeric(cross_section_ranked$Age)
```

Ranking Normalized Values for Each Metabolite. There are 162 Data Point Entries, and Ranking was from 1 to 162, in Which The Lowest Normalized Value was Ranked 1, and the Highest Value was Ranked 162. Values That were Missing were Ranked Lowest Average Value
```{r message=FALSE}
## Removing "_total" From Column Names in Health Files
colnames(diff_in_health_outcome) <- gsub("_total","",colnames(diff_in_health_outcome))
colnames(complete_health_outcome) <- gsub("_total","",colnames(complete_health_outcome))

outcomes <- colnames(complete_health_outcome)[4:length(complete_health_outcome)]

## Merge with Health File
cross_section_ranked <- merge(cross_section_ranked, complete_health_outcome, by=c("StudyID", "Period", "Trial"))
      
## Changing Class of "outcomes" to Numeric
cross_section_ranked[,outcomes] <- lapply(cross_section_ranked[,outcomes], function(x) {
  if(is.integer(x)) 
    as.numeric(x)
  else x
  })

datatable(as.data.frame(cross_section_ranked),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50,100)),
          class="cell-border stripe", caption="Method 1 Ranking")

write.csv(cross_section_ranked, paste0("./food_table/",food_name," Ranking_metabolites.csv"), row.names=F)
```

Creating Dataset for Change Analysis by Calculating Difference in Rank
```{r}
change_analysis_ranked <- cross_section_ranked
```

```{r}
subject_change_analysis <- unique(substr(change_analysis_ranked$StudyID, 1,3)) 
difference_ranked_change_analysis <- c()
      
for(j in subject_change_analysis){
  tmp.dat_change_analysis <- change_analysis_ranked[str_detect(change_analysis_ranked$StudyID, j),]
  
  for(k in 1:2){
    if(sum(tmp.dat_change_analysis$Trial == k) == 2){
      tmp.dat.trial_change_analysis <- tmp.dat_change_analysis[tmp.dat_change_analysis$Trial == k,]
      
      mets.dif_change_analysis <- as.data.frame(tmp.dat.trial_change_analysis[grepl("post",tmp.dat.trial_change_analysis$Time),
                                                                Metabolite]-
                                           tmp.dat.trial_change_analysis[grepl("pre",tmp.dat.trial_change_analysis$Time),
                                                                  Metabolite])
      
      mets.dif_change_analysis <- cbind(StudyID = j, Trial = k, Age = unique(tmp.dat.trial_change_analysis$Age),
                                 Sex = unique(tmp.dat.trial_change_analysis$Sex), mets.dif_change_analysis)
      
      difference_ranked_change_analysis <- rbind(difference_ranked_change_analysis, mets.dif_change_analysis)
    }
  }
}

datatable(as.data.frame(difference_ranked_change_analysis),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colreorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50)),
          class="cell-border stripe", caption=paste0("Change in Ranks For Unique to",food_name," Metabolites within Each Trial"))

write.csv(difference_ranked_change_analysis,
          paste0("./food_table/",food_name,
                 " Change_in_Ranks_Metabolites.csv"), row.names=F)
```
      
```{r}
## Merging with the Health Outcome File
difference_ranked_change_analysis <- merge(difference_ranked_change_analysis, diff_in_health_outcome, by = c("StudyID","Trial"))
      
## Changing Class for "StudyID"
difference_ranked_change_analysis$StudyID <- as.factor(difference_ranked_change_analysis$StudyID)

## Outcomes Class
difference_ranked_change_analysis[,outcomes] <- lapply(difference_ranked_change_analysis[,outcomes], function(x) {
  if(is.integer(x))
    as.numeric(as.character(x))
  else x
  })
```

## Assoication Between the Change in Ranks of Metabolite
### Primary Analysis Formula: Without any Covariates
```{r message=FALSE}
lmod1_ranked_2_change <- vector(mode = "list", length = 2)
change_analysis_change_no_cov <- c()
      
for(i in 1:length(Metabolite)){
  tryCatch({
    lmod1_ranked_2_change[[i]] <- lmer(as.formula(paste(Metabolite[i],"~ 1 + (1|StudyID)",
                                                        sep = "")),data = difference_ranked_change_analysis)
    
    change_no_cov <- cbind(data.frame(summary(lmod1_ranked_2_change[[i]])$coefficients),
                                    Singular_Fit = isSingular(lmod1_ranked_2_change[[i]]),
                                    Metabolite=paste0(Metabolite[i]))
    
    change_analysis_change_no_cov <- rbind(change_analysis_change_no_cov,change_no_cov)
    },
    error=function(e){
      })
}

colnames(change_analysis_change_no_cov) <- 
  c("Estimate_Intercept","Std_Error_Intercept","df_Intercept","t_value_Intercept","p_value_Intercept",
    "Singular_fit_Intercept","Metabolite")
      
## Calculating FDR and LogP
change_analysis_change_no_cov$FDR_Intercept <- p.adjust(change_analysis_change_no_cov$p_value, method = "BH")

## Creating "test_type", so Results Can be Divided Into "Intercept","Age","Sex","Trial", and "Metabolite"
change_analysis_change_no_cov$test_type <- rownames(change_analysis_change_no_cov)
change_analysis_change_no_cov[grepl("Intercept",change_analysis_change_no_cov$test_type),"test_type"] <- "Intercept"
rownames(change_analysis_change_no_cov) <- NULL
change_analysis_change_no_cov <- change_analysis_change_no_cov[,!grepl("t_value",colnames(change_analysis_change_no_cov))]

## Showing 4 Significant Digits
change_analysis_change_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  format(change_analysis_change_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],digits=4)
## Changing Class to Numeric
change_analysis_change_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  lapply(change_analysis_change_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],function(x) {as.numeric(x)})

change_analysis_change_no_cov <- merge(change_analysis_change_no_cov,metabolite_info,by="Metabolite")
      
datatable(as.data.frame(change_analysis_change_no_cov),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50)),
          class="cell-border stripe", caption="LMM for Change in Ranks of Unique to Salmmon Metabolites Without Covariates")
write.csv(change_analysis_change_no_cov,
          paste0("./food_table/",food_name, 
                 " Change_in_Ranks_Primary_Analysis.csv"), row.names=F)
```

#### Summary Plot of Primary Analysis (Without Covariates)
```{r message=FALSE}
change_analysis_no_cov_tile <- change_analysis_change_no_cov
change_analysis_no_cov_tile$value <- ifelse(change_analysis_no_cov_tile$p_value_Intercept < 0.05 & change_analysis_no_cov_tile$FDR_Intercept < 0.05,"Pass FDR", ifelse(change_analysis_no_cov_tile$p_value_Intercept < 0.05 & change_analysis_no_cov_tile$FDR_Intercept > 0.05,"Pass P-value","Fail P-value"))

hline <- function(y = 0, color = "black") {
  list(
    type = "line",
    x0 = 0,
    x1 = 1,
    xref = "paper",
    y0 = y,
    y1 = y,
    line = list(color = color, dash="dot")
  )
}
primary_change_plot <- plot_ly(data = change_analysis_no_cov_tile,x = ~Estimate_Intercept, 
        y = -log2(change_analysis_no_cov_tile$FDR_Intercept),
        color = as.character(change_analysis_no_cov_tile$value), type="scatter",mode="markers",
        hoverinfo = "text", colors = c("grey","red","blue"),
        text=paste0(change_analysis_no_cov_tile$Metabolite,"</br></br>",
                    paste0("Estimate_Intercept: ",change_analysis_no_cov_tile$Estimate_Intercept),"</br>",
                    paste0("-log2_FDR: ",-log2(change_analysis_no_cov_tile$FDR_Intercept)))) %>% 
  layout(shapes=list(hline(-log2(0.05))), title="Volcano Plots for Change in Metabolites After MED Diet",
         yaxis=list(title="-log2 of FDR"))
ggplotly(primary_change_plot)
saveWidget(primary_change_plot, file=paste0("./Analysis_Plots/", food_name," Change_in_Ranks_Primary_Analysis.html"))
```


### Secondary Analysis: With Covariates (Scaling "Age", and "Sex")
```{r message=FALSE}
difference_change_analysis_scale <- difference_ranked_change_analysis
difference_change_analysis_scale$Sex <- ifelse(difference_change_analysis_scale$Sex=="F",1,0)

lmod1_ranked_2_change_cov <- vector(mode = "list", length = 2)
change_analysis_change_cov <- c()
      
for(i in 1:length(Metabolite)){
  tryCatch({
    lmod1_ranked_2_change_cov[[i]] <- lmer(as.formula(paste(Metabolite[i],"~ scale(Age) + scale(Sex) + (1|StudyID)",
                                                        sep = "")),data = difference_change_analysis_scale)
    
    change_cov <- cbind(data.frame(summary(lmod1_ranked_2_change_cov[[i]])$coefficients),
                                    Singular_Fit = isSingular(lmod1_ranked_2_change_cov[[i]]),
                                    Metabolite=paste0(Metabolite[i]))
    
    change_analysis_change_cov <- rbind(change_analysis_change_cov,change_cov)
    },
    error=function(e){
      })
}

colnames(change_analysis_change_cov) <- c("Estimate","Std_Error","df","t_value","p_value","Singular_fit","Metabolite")

## Calculating FDR and LogP
change_analysis_change_cov$FDR <- p.adjust(change_analysis_change_cov$p_value, method = "BH")

## Creating "test_type", so Results Can be Divided Into "Intercept","Age","Sex","Trial", and "Metabolite"
change_analysis_change_cov$test_type <- rownames(change_analysis_change_cov)
change_analysis_change_cov[grepl("Intercept",change_analysis_change_cov$test_type),"test_type"] <- "Intercept"
change_analysis_change_cov[grepl("Age",change_analysis_change_cov$test_type),"test_type"] <- "Age"
change_analysis_change_cov[grepl("Sex",change_analysis_change_cov$test_type),"test_type"] <- "Sex"
rownames(change_analysis_change_cov) <- NULL
change_analysis_change_cov <- change_analysis_change_cov[,!grepl("t_value",colnames(change_analysis_change_cov))]

## Showing 4 Significant Digits
change_analysis_change_cov[,c("Estimate","Std_Error","df","p_value","FDR")] <-
  format(change_analysis_change_cov[,c("Estimate","Std_Error","df","p_value","FDR")],digits=4)

## Reshaping From Long to Wide
change_analysis_change_cov <- reshape(change_analysis_change_cov,timevar="test_type",idvar="Metabolite",direction="wide")
colnames(change_analysis_change_cov) <- gsub("\\.","_",colnames(change_analysis_change_cov))

## Removing Unwanted Columns
change_analysis_change_cov <- change_analysis_change_cov[,grepl("Estimate|p_value|Intercept|Metabolite",colnames(change_analysis_change_cov))]

## Changing Class to Numeric
change_analysis_change_cov[,2:ncol(change_analysis_change_cov)] <- 
  lapply(change_analysis_change_cov[,2:ncol(change_analysis_change_cov)], function(x) {as.numeric(x)})

## Changing to "Singular_fit" to TRUE and FALSE
singular_col_change_cov <- grep("Singular",colnames(change_analysis_change_cov))
for(i in singular_col_change_cov){
  change_analysis_change_cov[,i] <- ifelse(change_analysis_change_cov[,i]==0,"FALSE","TRUE")
}

change_analysis_change_cov <- merge(change_analysis_change_cov,metabolite_info,by="Metabolite")
      
datatable(as.data.frame(change_analysis_change_cov),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50)),
          class="cell-border stripe", caption=paste0("LMM for Change in Ranks of Unique to",food_name," Metabolites with Covariates"))
write.csv(change_analysis_change_cov,
          paste0("./food_table/",food_name,
                 " Change_in_Ranks_Secondary_Analysis.csv"), row.names=F)
```

#### Summary Plot of Secondary Analysis (With Covariates)
```{r message=FALSE}
change_analysis_change_cov_tile <- change_analysis_change_cov
change_analysis_change_cov_tile$value <- ifelse(change_analysis_change_cov_tile$p_value_Intercept < 0.05 & change_analysis_change_cov_tile$FDR_Intercept < 0.05,"Pass FDR", ifelse(change_analysis_change_cov_tile$p_value_Intercept < 0.05 & change_analysis_change_cov_tile$FDR_Intercept > 0.05,"Pass P-value","Fail P-value"))

secondary_change_plot <- plot_ly(data = change_analysis_change_cov_tile,x = ~Estimate_Intercept, 
                                 y = -log2(change_analysis_change_cov_tile$FDR_Intercept), 
                                 color = as.character(change_analysis_change_cov_tile$value), type="scatter",mode="markers",
                                 hoverinfo = "text",colors = c("grey","red","blue"),
                                 text=paste0(change_analysis_change_cov_tile$Metabolite,"</br></br>",
                                             paste0("Estimate_Intercept: ",change_analysis_change_cov_tile$Estimate_Intercept),
                                             "</br>",
                                             paste0("-log2_FDR: ",-log2(change_analysis_change_cov_tile$FDR_Intercept)))) %>% 
  layout(shapes=list(hline(-log2(0.05))), title="Volcano Plots for Change in Metabolites After MED Diet with Covariates",
         yaxis=list(title="-log2 of FDR"))
saveWidget(secondary_change_plot,
           file=paste0("./Analysis_Plots/",food_name,
                       " Change_in_Ranks_Secondary_Analysis.html"))
ggplotly(secondary_change_plot)
```

## Stratified Analysis of "Sex"
### Male
#### Primary Analysis for Association Between Change in Metabolite Rankings
```{r message=FALSE}
Strat_M <- difference_ranked_change_analysis[grepl("M", difference_ranked_change_analysis$Sex),]
Strat_F <- difference_ranked_change_analysis[grepl("F", difference_ranked_change_analysis$Sex),]

## no cov on M
lmod1_strat_M_no <- vector(mode = "list", length = 2)
method_M_no_cov <- c()

for(i in 1:length(Metabolite)){
  tryCatch({
    lmod1_strat_M_no[[i]] <- lmer(as.formula(paste(Metabolite[i],"~ 1 + (1|StudyID)",sep = "")),data = Strat_M)

    M_no_cov <- cbind(data.frame(summary(lmod1_strat_M_no[[i]])$coefficients),
                                    Singular_Fit = isSingular(lmod1_strat_M_no[[i]]),
                                    Metabolite=paste0(Metabolite[i]))

    method_M_no_cov <- rbind(method_M_no_cov,M_no_cov)
    },
    error=function(e){
      })
}

colnames(method_M_no_cov) <-
  c("Estimate_Intercept","Std_Error_Intercept","df_Intercept","t_value_Intercept","p_value_Intercept",
    "Singular_fit_Intercept","Metabolite")

## Calculating FDR and LogP
method_M_no_cov$FDR_Intercept <- p.adjust(method_M_no_cov$p_value, method = "BH")

## Creating "test_type", so Results Can be Divided Into "Intercept","Age","Sex","Trial", and "Metabolite"
method_M_no_cov$test_type <- rownames(method_M_no_cov)
method_M_no_cov[grepl("Intercept",method_M_no_cov$test_type),"test_type"] <- "Intercept"
rownames(method_M_no_cov) <- NULL
method_M_no_cov <- method_M_no_cov[,!grepl("t_value",colnames(method_M_no_cov))]

## Showing 4 Significant Digits
method_M_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  format(method_M_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],digits=4)
## Changing Class to Numeric
method_M_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  lapply(method_M_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],function(x) {as.numeric(x)})

method_M_no_cov <- merge(method_M_no_cov,metabolite_info,by="Metabolite")

datatable(as.data.frame(method_M_no_cov),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50,100)),
          class="cell-border stripe", caption=paste0("Stratified LMM for Change in Ranks of Unique to",food_name," Metabolites w/o Covariates for Males"))
write.csv(method_M_no_cov, paste0("./food_table/",food_name,
                                  " Stratified_Change_in_Ranks_Primary_Males.csv"), row.names=F)
```

##### Summary Plot of Stratified Analysis for Males (Without Covariates)
```{r message=FALSE}
method_M_no_cov_tile <- method_M_no_cov
method_M_no_cov_tile$value <- ifelse(method_M_no_cov_tile$p_value_Intercept < 0.05 & method_M_no_cov_tile$FDR_Intercept < 0.05,"Pass FDR", ifelse(method_M_no_cov_tile$p_value_Intercept < 0.05 & method_M_no_cov_tile$FDR_Intercept > 0.05,"Pass P-value","Fail P-value"))

primary_M_plot <- plot_ly(data = method_M_no_cov_tile,x = ~Estimate_Intercept, y = -log2(method_M_no_cov_tile$FDR_Intercept), 
                          color = as.character(method_M_no_cov_tile$value), type="scatter",mode="markers",
                          hoverinfo = "text",colors = c("grey","red","blue"),
                          text=paste0(method_M_no_cov_tile$Metabolite,"</br></br>",
                                      paste0("Estimate_Intercept: ",method_M_no_cov_tile$Estimate_Intercept),"</br>",
                                      paste0("-log2_FDR: ",-log2(method_M_no_cov_tile$FDR_Intercept)))) %>% 
  layout(shapes=list(hline(-log2(0.05))), 
         title="Volcano Plots for Stratified Analysis Based on Sex(Males) without Covariates",yaxis=list(title="-log2 of FDR"))
saveWidget(primary_M_plot, file=paste0("./Analysis_Plots/",food_name," Change_in_Ranks_Primary_Analysis_Males.html"))
ggplotly(primary_M_plot)
```

#### Secondary Analysis for Association Between Change in Metabolite Rankings
```{r message=FALSE}
## cov on M
lmod1_strat_M <- vector(mode = "list", length = 2)
method_M_cov <- c()

for(i in 1:length(Metabolite)){
  tryCatch({
    lmod1_strat_M[[i]] <- lmer(as.formula(paste(Metabolite[i],"~ scale(Age) + (1|StudyID)",sep = "")),data = Strat_M)

    M_cov <- cbind(data.frame(summary(lmod1_strat_M[[i]])$coefficients),
                                    Singular_Fit = isSingular(lmod1_strat_M[[i]]),
                                    Metabolite=paste0(Metabolite[i]))

    method_M_cov <- rbind(method_M_cov,M_cov)
    },
    error=function(e){
      })
}

colnames(method_M_cov) <-
  c("Estimate_Intercept","Std_Error_Intercept","df_Intercept","t_value_Intercept","p_value_Intercept",
    "Singular_fit_Intercept","Metabolite")

## Calculating FDR and LogP
method_M_cov$FDR_Intercept <- p.adjust(method_M_cov$p_value, method = "BH")

## Creating "test_type", so Results Can be Divided Into "Intercept","Age","Sex","Trial", and "Metabolite"
method_M_cov$test_type <- rownames(method_M_cov)
method_M_cov[grepl("Intercept",method_M_cov$test_type),"test_type"] <- "Intercept"
rownames(method_M_cov) <- NULL
method_M_cov <- method_M_cov[,!grepl("t_value",colnames(method_M_cov))]
method_M_cov <- method_M_cov[grepl("Intercept",method_M_cov$test_type),]

## Showing 4 Significant Digits
method_M_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  format(method_M_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],digits=4)
## Changing Class to Numeric
method_M_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  lapply(method_M_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],function(x) {as.numeric(x)})

datatable(as.data.frame(method_M_cov),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50,100)),
          class="cell-border stripe", caption=paste0("Stratified LMM for Change in Ranks of Unique to",food_name," Metabolites with Covariates for Males"))
write.csv(method_M_cov, paste0("./food_table/",food_name,
                               " Stratified_Change_in_Ranks_Secondary_Males.csv"), row.names=F)
```

##### Summary Plot of Stratified Analysis for Males (With Covariates)
```{r message=FALSE}
method_M_cov_tile <- method_M_cov
method_M_cov_tile$value <- ifelse(method_M_cov_tile$p_value_Intercept < 0.05 & method_M_cov_tile$FDR_Intercept < 0.05,"Pass FDR", ifelse(method_M_cov_tile$p_value_Intercept < 0.05 & method_M_cov_tile$FDR_Intercept > 0.05,"Pass P-value","Fail P-value"))

secondary_M_plot <- plot_ly(data = method_M_cov_tile,x = ~Estimate_Intercept, y = -log2(method_M_cov_tile$FDR_Intercept),
                            color = as.character(method_M_cov_tile$value), type="scatter",mode="markers",
                            hoverinfo = "text",colors = c("grey","red","blue"),
                            text=paste0(method_M_cov_tile$Metabolite,"</br></br>",
                                        paste0("Estimate_Intercept: ",method_M_cov_tile$Estimate_Intercept),"</br>",
                                        paste0("-log2_FDR: ",-log2(method_M_cov_tile$FDR_Intercept)))) %>% 
  layout(shapes=list(hline(-log2(0.05))), title="Volcano Plots for Stratified Analysis Based on Sex(Males) with
         Covariates",yaxis=list(title="-log2 of FDR"))
saveWidget(secondary_M_plot, file=paste0("./Analysis_Plots/", food_name," Change_in_Ranks_Secondary_Analysis_Males.html"))
ggplotly(secondary_M_plot)
```

### Female
#### Primary Analysis for Association Between Change in Metabolite Rankings
```{r message=FALSE}
## no cov on F
lmod1_strat_F_no <- vector(mode = "list", length = 2)
method_F_no_cov <- c()

for(i in 1:length(Metabolite)){
  tryCatch({
    lmod1_strat_F_no[[i]] <- lmer(as.formula(paste(Metabolite[i],"~ 1 + (1|StudyID)",sep = "")),data = Strat_F)

    F_no_cov <- cbind(data.frame(summary(lmod1_strat_F_no[[i]])$coefficients),
                                    Singular_Fit = isSingular(lmod1_strat_F_no[[i]]),
                                    Metabolite=paste0(Metabolite[i]))

    method_F_no_cov <- rbind(method_F_no_cov,F_no_cov)
    },
    error=function(e){
      })
}

colnames(method_F_no_cov) <-
  c("Estimate_Intercept","Std_Error_Intercept","df_Intercept","t_value_Intercept","p_value_Intercept",
    "Singular_fit_Intercept","Metabolite")

## Calculating FDR and LogP
method_F_no_cov$FDR_Intercept <- p.adjust(method_F_no_cov$p_value, method = "BH")

## Creating "test_type", so Results Can be Divided Into "Intercept","Age","Sex","Trial", and "Metabolite"
method_F_no_cov$test_type <- rownames(method_F_no_cov)
method_F_no_cov[grepl("Intercept",method_F_no_cov$test_type),"test_type"] <- "Intercept"
rownames(method_F_no_cov) <- NULL
method_F_no_cov <- method_F_no_cov[,!grepl("t_value",colnames(method_F_no_cov))]

## Showing 4 Significant Digits
method_F_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  format(method_F_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],digits=4)
## Changing Class to Numeric
method_F_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  lapply(method_F_no_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],function(x) {as.numeric(x)})

datatable(as.data.frame(method_F_no_cov),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50,100)),
          class="cell-border stripe", caption=paste0("Stratified LMM for Change in Ranks of Unique to",food_name," Metabolites w/o Covariates for Females"))
write.csv(method_F_no_cov, paste0("./food_table/",food_name,
                                  " Stratified_Change_in_Ranks_Primary_Females.csv"), row.names=F)
```

##### Summary Plot of Stratified Analysis for Females (Without Covariates)
```{r message=FALSE}
method_F_no_cov_tile <- method_F_no_cov
method_F_no_cov_tile$value <- ifelse(method_F_no_cov_tile$p_value_Intercept < 0.05 & method_F_no_cov_tile$FDR_Intercept < 0.05,"Pass FDR", ifelse(method_F_no_cov_tile$p_value_Intercept < 0.05 & method_F_no_cov_tile$FDR_Intercept > 0.05,"Pass P-value","Fail P-value"))

primary_F_plot <- plot_ly(data = method_F_no_cov_tile,x = ~Estimate_Intercept, y = -log2(method_F_no_cov_tile$FDR_Intercept), 
                          color = as.character(method_F_no_cov_tile$value), type="scatter",mode="markers",
                          hoverinfo = "text",colors = c("grey","red","blue"),
                          text=paste0(method_F_no_cov_tile$Metabolite,"</br></br>",
                                      paste0("Estimate_Intercept: ",method_F_no_cov_tile$Estimate_Intercept),"</br>",
                                      paste0("-log2_FDR: ",-log2(method_F_no_cov_tile$FDR_Intercept)))) %>% 
  layout(shapes=list(hline(-log2(0.05))), title="Volcano Plots for Stratified Analysis Based on Sex(Females) without
         Covariates",yaxis=list(title="-log2 of FDR"))
saveWidget(primary_F_plot, file=paste0("./Analysis_Plots/",food_name," Change_in_Ranks_Primary_Analysis_Females.html"))
ggplotly(primary_F_plot)
```

#### Secondary Analysis for Association Between Change in Metabolite Rankings
```{r message=FALSE}
## cov on F
lmod1_strat_F <- vector(mode = "list", length = 2)
method_F_cov <- c()

for(i in 1:length(Metabolite)){
  tryCatch({
    lmod1_strat_F[[i]] <- lmer(as.formula(paste(Metabolite[i],"~ scale(Age) + (1|StudyID)",sep = "")),data = Strat_F)

    F_cov <- cbind(data.frame(summary(lmod1_strat_F[[i]])$coefficients),
                                    Singular_Fit = isSingular(lmod1_strat_F[[i]]),
                                    Metabolite=paste0(Metabolite[i]))

    method_F_cov <- rbind(method_F_cov,F_cov)
    },
    error=function(e){
      })
}

colnames(method_F_cov) <-
  c("Estimate_Intercept","Std_Error_Intercept","df_Intercept","t_value_Intercept","p_value_Intercept",
    "Singular_fit_Intercept","Metabolite")

## Calculating FDR and LogP
method_F_cov$FDR_Intercept <- p.adjust(method_F_cov$p_value, method = "BH")

## Creating "test_type", so Results Can be Divided Into "Intercept","Age","Sex","Trial", and "Metabolite"
method_F_cov$test_type <- rownames(method_F_cov)
method_F_cov[grepl("Intercept",method_F_cov$test_type),"test_type"] <- "Intercept"
rownames(method_F_cov) <- NULL
method_F_cov <- method_F_cov[,!grepl("t_value",colnames(method_F_cov))]
method_F_cov <- method_F_cov[grepl("Intercept",method_F_cov$test_type),]

## Showing 4 Significant Digits
method_F_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  format(method_F_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],digits=4)
## Changing Class to Numeric
method_F_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                          "p_value_Intercept","FDR_Intercept")] <-
  lapply(method_F_cov[,c("Estimate_Intercept","Std_Error_Intercept","df_Intercept",
                                   "p_value_Intercept","FDR_Intercept")],function(x) {as.numeric(x)})

datatable(as.data.frame(method_F_cov),rownames=F,extensions=c("Buttons","ColReorder"),
          options=list(dom="Bfrtipl",scrollY=TRUE,scrollX=TRUE,colReorder=TRUE,buttons=c("excel","csv"),
                       pageLength=10,lengthMenu=c(10,25,50,100)),
          class="cell-border stripe", caption=paste0("Stratified LMM for Change in Ranks of Unique to",food_name," Metabolites with Covariates for Females"))
write.csv(method_F_cov, paste0("./food_table/",food_name,
                               " Stratified_Change_in_Ranks_Secondary_Females.csv"), row.names=F)
```

##### Summary Plot of Stratified Analysis for Females (With Covariates)
```{r message=FALSE}
method_F_cov_tile <- method_F_cov
method_F_cov_tile$value <- ifelse(method_F_cov_tile$p_value_Intercept < 0.05 & method_F_cov_tile$FDR_Intercept < 0.05,"Pass FDR", ifelse(method_F_cov_tile$p_value_Intercept < 0.05 & method_F_cov_tile$FDR_Intercept > 0.05,"Pass P-value","Fail P-value"))

secondary_F_plot <- plot_ly(data = method_F_cov_tile,x = ~Estimate_Intercept, y = -log2(method_F_cov_tile$FDR_Intercept), 
                            color = as.character(method_F_cov_tile$value), type="scatter",mode="markers",
                            hoverinfo = "text",colors = c("grey","red","blue"),
                            text=paste0(method_F_cov_tile$Metabolite,"</br></br>",
                                        paste0("Estimate_Intercept: ",method_F_cov_tile$Estimate_Intercept),"</br>",
                                        paste0("-log2_FDR: ",-log2(method_F_cov_tile$FDR_Intercept)))) %>% 
  layout(shapes=list(hline(-log2(0.05))), title="Volcano Plots for Stratified Analysis Based on Sex(Females) with
         Covariates",yaxis=list(title="-log2 of FDR"))
saveWidget(secondary_F_plot, file=paste0("./Analysis_Plots/",food_name," Change_in_Ranks_Secondary_Analysis_Females.html"))
ggplotly(secondary_F_plot)
```

